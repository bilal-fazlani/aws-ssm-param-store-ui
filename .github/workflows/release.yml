name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_ENV"

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Import Developer ID certificate
        uses: Apple-Actions/import-codesign-certs@v6
        with:
          p12-file-base64: ${{ secrets.DEVELOPER_ID_CERT_P12 }}
          p12-password: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}

      - name: Archive
        run: |
          xcodebuild archive \
            -project AWSSSMParamStoreUI.xcodeproj \
            -scheme AWSSSMParamStoreUI \
            -destination "generic/platform=macOS" \
            -archivePath "$RUNNER_TEMP/AWSSSMParamStoreUI.xcarchive" \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM=6P85FFF835

      - name: Export .app
        run: |
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/AWSSSMParamStoreUI.xcarchive" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist ExportOptions.plist

      - name: Create DMG
        # DMG is named with dots (not spaces) to avoid shell-quoting issues in
        # later steps and to match the download URL pattern GitHub produces.
        run: |
          mkdir -p "$RUNNER_TEMP/dmg-staging"
          cp -R "$RUNNER_TEMP/export/AWSSSMParamStoreUI.app" "$RUNNER_TEMP/dmg-staging/"
          hdiutil create \
            -volname "AWS SSM Param Store UI" \
            -srcfolder "$RUNNER_TEMP/dmg-staging" \
            -ov \
            -format UDZO \
            "$RUNNER_TEMP/AWS.SSM.Param.Store.UI-$VERSION.dmg"
          echo "DMG_PATH=$RUNNER_TEMP/AWS.SSM.Param.Store.UI-$VERSION.dmg" >> "$GITHUB_ENV"

      - name: Sign DMG
        run: |
          codesign \
            --sign "Developer ID Application: Bilal Fazlani (6P85FFF835)" \
            --timestamp \
            --force \
            "$DMG_PATH"

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.NOTARIZATION_APPLE_ID }}
          TEAM_ID: ${{ secrets.NOTARIZATION_TEAM_ID }}
          APP_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
        run: |
          xcrun notarytool submit "$DMG_PATH" \
            --apple-id "$APPLE_ID" \
            --team-id "$TEAM_ID" \
            --password "$APP_PASSWORD" \
            --wait

      - name: Staple notarization ticket
        run: xcrun stapler staple "$DMG_PATH"

      - name: Compute SHA-256
        run: |
          SHA=$(shasum -a 256 "$DMG_PATH" | awk '{print $1}')
          echo "DMG_SHA256=$SHA" >> "$GITHUB_ENV"

      - name: Prepare release notes
        run: |
          NOTES_FILE="release_notes/v$VERSION.md"
          if [ -f "$NOTES_FILE" ]; then
            cp "$NOTES_FILE" "$RUNNER_TEMP/release-notes.md"
          else
            touch "$RUNNER_TEMP/release-notes.md"
          fi

      - name: Create GitHub Release and upload DMG
        uses: softprops/action-gh-release@v2
        with:
          body_path: ${{ runner.temp }}/release-notes.md
          generate_release_notes: true
          files: ${{ env.DMG_PATH }}

      - name: Update Homebrew cask
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          formula-name: aws-ssm-param-store-ui
          formula-path: Casks/aws-ssm-param-store-ui.rb
          homebrew-tap: bilal-fazlani/homebrew-tap
          download-url: https://github.com/bilal-fazlani/aws-ssm-param-store-ui/releases/download/${{ github.ref_name }}/AWS.SSM.Param.Store.UI-${{ env.VERSION }}.dmg
          download-sha256: ${{ env.DMG_SHA256 }}
          create-pullrequest: false
        env:
          COMMITTER_TOKEN: ${{ secrets.TAP_REPO_TOKEN }}
